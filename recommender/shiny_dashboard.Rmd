---
title: "Restaurant Recommender"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(rmarkdown)
library(flexdashboard)
library(tidyverse)
library(plotly)
library(p8105.datasets)
library(viridis)

library(shiny)
library(shinyWidgets)




```

```{r golbal, context = "data"}

all_res_df = read_csv("shiny_data/inspection_sub_all_date.csv") %>%
  nest(inspection_detail = action:critical_flag) %>% 
  mutate(price_count = str_count(price, fixed("$")))

latest_res_df = read_csv("shiny_data/inspection_sub_latest_date.csv") %>%
  nest(inspection_detail = action:critical_flag)%>% 
  mutate(price_count = str_count(price, fixed("$")))

cuisine_list = 
  all_res_df %>% 
  select(cuisine_description) %>% 
  count(cuisine_description) %>% 
  arrange(desc(n)) %>% 
  slice(1:10) %>% 
  select(cuisine_description) %>% 
  add_row(cuisine_description = "Others") %>%
  pull()

price_list = c(
  "$ <10",
  "$$ 10-30",
  "$$$ 31-60",
  "$$$$ >60"
)

sort_list_1 = c(
  "distance", 
  "rating", 
  "price",
  "inspection date"
)

sort_list_2 = c(
  "rating", 
  "price",
  "inspection date"
)

```

User Input {.sidebar data-width=300}
-----------------------------------------------------------------------

```{r user_input}
selectInput(
  inputId = "boro_choice",
  label = "Select borough",
  choices = all_res_df %>% distinct(boro) %>% pull()
)

textInput(
  inputId = "street", 
  label = "Street (Optional)")

# reactive(input$street)

selectInput(
  inputId = "cuisince_choice",
  label = "Select cuisine type", 
  choice = cuisine_list
)

sliderInput(
  inputId = "rating_range",
  label = "Choose rating range",
  min = 0.0, max = 5.0, value = c(3.0, 4.5), step = 0.1, round = -2
)

sliderTextInput(
  inputId = "price_range",
  label = "Choose price range" , 
  choices = price_list, 
  selected = c(price_list[1], price_list[4])
)



sliderInput(
  "inspection_range",
  label = "Choose inspection score range",
  min = 0, max = 100, value = c(0, 100)
)

# sort_list = ifelse(
#   renderText(input$street) == "",
#   0, 
#   sort_list_2, 
#   sort_list_1
# )



sort_list = sort_list_2
actionButton(
  "search_button", "Search"
)
```

Column {data-width= 700}
-----------------------------------------------------------------------

### table

```{r}
res_table = eventReactive(input$search_button,
                            latest_res_df  %>% 
    filter(boro == input$boro_choice, 
           cuisine_description ==  input$cuisince_choice, 
           rating %in% seq(input[["rating_range"]][1],input[["rating_range"]][2], 0.1), 
           price_count %in% 
             str_count(input$price_range[1],fixed("$")):str_count(input$price_range[2], fixed("$")), 
           score %in% input$inspection_range[1]:input$inspection_range[2]) %>%
    select(dba, building, street, rating, price, score) %>% 
    arrange(desc(rating)) %>% 
    rename(name = dba, inspection = score))

renderDataTable(
  res_table(),
      options = list(
        scrollX = TRUE,
        scrollY = "500px", 
        dom = "ft"
      )
)



# renderText({ 
#   c(input[["boro_choice"]], input[["boro_choice"]])
# })

# renderPlotly({ 
#   nyc_airbnb %>%
#   filter(
#     borough == input[["boro_choice"]], 
#     price %in% input[["price_range"]][1]:input[["price_range"]][2],
#     room_type == input[["room_choice"]] )%>%
#   mutate(text_label = str_c("Price: $", price, '\nRating: ', stars)) %>% 
#   plot_ly(
#     x = ~lat, y = ~long, type = "scatter", mode = "markers",
#     alpha = 0.5, color = ~price, text = ~text_label)
# })

```

Column {data-width=200}
-----------------------------------------------------------------------

### Chart B

```{r}
str = eventReactive(input$search_button, str_count(input$price_range[1], fixed("$")):str_count(input$price_range[2], fixed("$")))
renderPrint({
  str()
})
```

### Chart C

```{r}
# renderText({ 
#   seq(input[["rating_range"]][1], input[["rating_range"]][2], 0.1)
# })
reactive(input$rating_range)

```

