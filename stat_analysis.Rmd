---
title: "Statistical Analysis"
---
```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(gtsummary)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r}
library(readr)
dt = read_csv("data/inspection_sub_all_date.csv")
df = read_csv("data/inspection_sub_latest_date.csv") %>%
  mutate(price = fct_recode(price, `1`="$", `2`="$$", `3`="$$$", `4`="$$$$"),
         boro = fct_reorder(boro, rating),
         grade = fct_relevel(grade, "A")) 

```

```{r}
df %>% 
  select(boro, score, grade, rating, review_num, price) %>% 
  tbl_summary(
    missing_text = "(Missing)", 
    statistic = list(
      all_continuous() ~ "{mean} ({sd})", 
      all_categorical() ~ "{n} ({p}%)"
      )) %>% 
  bold_labels() %>%   
  italicize_levels() 
```

## Chi-square Test

We try to determine whether there is a relationship between boroughs and restaurants' inspection grades. Our hypothesis is that there is no difference in the number of restaurants across the five grades across the five boroughs in NYC. We will perform the chi-square test to verify our assumption.

$H0$: the expected number of restaurants in each grades are the same across all boroughs.

$H1$: the expected number of restaurants in each grades are not same across all boroughs.

```{r}
grade_boro = 
  df %>% 
  drop_na(grade) %>% 
  count(boro, grade) %>% 
  pivot_wider(
    names_from = "grade",
    values_from = "n") %>%
  replace(is.na(.), 0) %>% 
  data.matrix() %>%
  subset(select = -c(boro))

rownames(grade_boro) <- c("Bronx", "Staten Island", "Queens", "Brooklyn", "Manhattan")

grade_boro %>% 
  knitr::kable(caption = "Results Table")
```

```{r}
chisq.test(grade_boro)
```

Interpretation: The result of chi-square shows that p-value is less than 0.05, so we reject the null hypothesis at 95% significant level and conclude that the inspection grades of restaurants are significantly different by boroughs. 



## Proportion Test

Now, we want to see whether receiving grade A is equally common among restaurants of all four price scales. To do this, we will conduct a proportion test.

```{r}
total = df %>% 
  group_by(price) %>% 
  summarise(total = n())

n_a = df %>% 
  count(price, grade) %>% 
  filter(grade == "A")

join = left_join(total, n_a) %>% drop_na()
prop.test(join$n, join$total)

#join = join %>% 
 # mutate(prop = n/total) %>% 
 # select(price, prop)
```

From the test result, we can see that the p-value is less than 0.05,  

```{r}
total = df %>% 
  select(boro, score, grade, rating, review_num, price) %>%
  drop_na(price, grade) %>% 
  group_by(price) %>%
  summarise(sum = n())

price_grade = df %>% 
  select(boro, score, grade, rating, review_num, price) %>%
  drop_na(price, grade) %>% 
  group_by(price, grade) %>% 
  summarise(n = n())

left_join(price_grade, total) %>% 
  mutate(prop = n/sum) %>% 
  pivot_wider(
    names_from = grade,
    values_from = prop 
  ) %>% 
  replace(is.na(.), 0) %>% 
  data.matrix() %>%
  subset(select = -c(price))

```

## Regression model

```{r}
df %>% 
  select(boro, score, grade, rating, review_num, price) %>%
  summary()

lm(rating ~ grade*price, data = df)
```



