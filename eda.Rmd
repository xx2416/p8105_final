---
title: "Exploratory Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggridges)
library(patchwork)
```


```{r include=FALSE}
inspection_raw<-read.csv("data/inspection_sub_latest_date.csv") %>% 
  janitor::clean_names()
```

## Top 10 cuisine in the whole NYC and by boro
As a real international metropolitan, There is a total of 80 different cuisine types in NYC based on our dataset and we firstly plot the 10 most frequently shown cuisine types in NYC.
```{r echo = FALSE, warning=FALSE}
top_10_cuisine_nyc<-
  inspection_raw %>% 
  drop_na(boro) %>%
  group_by(cuisine_description) %>% 
  summarise(n=n()) %>% 
  filter(min_rank(desc(n))<=10) %>%
  mutate(cuisine_description=fct_reorder(cuisine_description,n,.desc=TRUE)) %>% 
  ggplot(aes(x=cuisine_description,y=n,fill=cuisine_description))+
  geom_bar(position="dodge", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(
    x="cuisine type",
    y="Number"
  )

ggplotly(top_10_cuisine_nyc)
```
From the plot above, the top 10 cuisine types across NYC include `American`, `Chinese`, `Coffee/Tea`, `Pizza`, `Bakery Products/Desserts`, `Mexican`, `Japanese`, `Italian`, `latin American`, `Caribbean`, which implies the racial diversity of NYC. `American`, `Chinese`, `Coffee/Tea` are the top 3 favorite cuisine types for NY citizens. We then inspect the top 10 frequently shown cuisine types in different boroughs. 
```{r echo = FALSE, warning=FALSE}
boro_cuisine_bar<-
inspection_raw %>% 
  select(dba,boro,cuisine_description,critical_flag,score,grade,grade_date,inspection_type,latitude,longitude,rating,review_num,price) %>%
  drop_na(boro) %>% 
  mutate(cuisine_description=fct_infreq(cuisine_description),
         boro=fct_infreq(boro)) %>% 
  group_by(boro,cuisine_description) %>%
  summarize(n_obs=n()) %>% 
  filter(min_rank(desc(n_obs)) <= 10) %>%
  ggplot(aes(x=cuisine_description,y=n_obs,fill=cuisine_description))+
  geom_bar(position="dodge", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  theme(axis.text.x = element_text(size = 5))+
  labs(
    x="Cuisine type",
    y="Number")+
  facet_grid(~boro)

ggplotly(boro_cuisine_bar)
```
From the plot above, the top 10 cuisine types across NYC include `American`, `Chinese`, `Coffee/Tea`, `Pizza`, `Mexican`, `Japanese`, `Italian`, `latin American`, `Caribbean`, which implies the racial diversity of NYC. The top 3 frequently cuisine types in `Manhattan` and `Brooklyn` are `American`, `Coffee/Tea`, and `Chinese`. 


## price vs cuisine

```{r}
price_cuisine<-
  inspection_raw %>% 
  select(dba,boro,cuisine_description,critical_flag,score,grade,grade_date,inspection_type,latitude,longitude,rating,review_num,price) %>%
  drop_na(boro,price) %>% 
  mutate(price=as.factor(price)) %>% 
  group_by(price)%>%
  count(cuisine_description) %>%
  mutate(cuisine_description=fct_reorder(cuisine_description,n)) %>%
  filter(min_rank(desc(n))<=10) %>%
  ggplot(aes(x=cuisine_description,y=n,fill=price))+
  geom_bar(position="dodge", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  theme(axis.text.x = element_text(size = 5))+
  labs(
    x="Cuisine type",
    y="Number")+
  facet_grid(~price)


ggplotly(price_cuisine)

```

## Price vs. borough
```{r}
price_boro<-
  inspection_raw %>% 
  select(dba,boro,cuisine_description,critical_flag,score,grade,grade_date,inspection_type,latitude,longitude,rating,review_num,price) %>%
  drop_na(boro,price) %>%
  mutate(boro = fct_infreq(boro),
         price=as.factor(price)) %>%
  ggplot(aes(x = boro, fill = price)) + 
  geom_bar()

ggplotly(price_boro)
```

## review number vs. rating score (exclude extreme outliers)
```{r}
review_num_rating<-
  inspection_raw %>% 
  select(dba,boro,cuisine_description,critical_flag,score,grade,grade_date,inspection_type,latitude,longitude,rating,review_num,price) %>% drop_na(boro,price,rating) %>%
  filter(!review_num<=100) %>%
  group_by(rating) %>%
  summarize(sum_review=sum(review_num)) %>% 
  ggplot(aes(y=sum_review,x=rating))+
  geom_point()+
  geom_smooth()+
  labs(
    x="Sum of review_numbers",
    y="Rating"
  )

ggplotly(review_num_rating)
```

## top_10 violation
```{r}
inspection_raw = read_csv("./data/inspection_sub_all_date.csv") %>%
  janitor::clean_names() %>%
  mutate(
    violation_description = as.factor(violation_description)
  ) 
  
top_10_vio = inspection_raw %>% 
  group_by(violation_description) %>%
  summarize(
    n = n()
  ) %>%
  mutate(
    rank = rank(-n, ties.method = "first")
  ) %>% 
  filter(rank <=10) %>%
  arrange(desc(n)) %>% mutate(
    rank = as.factor(rank)
  ) %>%
  mutate(
    abb_violation = fct_recode(
      rank,
      "Non-food contact surface improperly constructed" = "1",
      "Food contact surface not properly cleaned" = "2",
      "Unacceptable materials" = "3",
      "Facility not vermin proof" = "4", 
      "Not free of harborage" = "5",
      "Evidence of mice or live mice present" = "6",
      "Filth flies or food/refuse/sewage with FRSA  flies"  = "7",
      "Cold CT food held above 41 F" = "8",
      "Cold food item held above 41 F" = "9",
     "Evidence of mice or live mice in establishmentâ€™s food or non-food areas" = "10"
        )
  )



top_10_vio %>%
  ggplot(aes(x = rank, y = n, fill = n), data = .)+geom_bar(stat="identity")+labs(x = "violation type", y = "frequency", caption = "Exact violation type and associated frquency is shown in the following table")
  
top_10_vio %>% 
  select(abb_violation, n) %>%
  knitr::kable()
```
## top 10 violations vs. cuisine type
```{r}

vio_cuisine_bar<-
  inspection_raw %>% 
  filter(violation_description %in% top_10_vio$violation_description) %>%
  group_by(violation_description,cuisine_description) %>% 
  summarize(n_obs=n()) %>% 
  filter(min_rank(desc(n_obs))<=5) %>%
  left_join(top_10_vio) %>% 
  select(abb_violation,cuisine_description,n_obs,rank) %>% 
  ggplot(aes(x=cuisine_description
             ,y=n_obs,fill=cuisine_description))+
  geom_bar(position="dodge", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  theme(axis.text.x = element_text(size = 4))+
  labs(
    x="top 5 cuisine types at top 10 most frequently appeared violation",
    y="Number"
  )+
  facet_grid(~rank)
  

ggplotly(vio_cuisine_bar)
```

## grade associated with the inspection vs. boro / cuisine type
```{r}
grade_boro<-
  inspection_raw %>% 
  filter(grade %in% c("A","B","C")) %>%
  mutate(boro=fct_infreq(boro)) %>% 
  ggplot(aes(x = boro, fill = grade))+
  geom_bar()+
  labs(
    x="Borough",
    y="Number"
  )

top_10_cuisine<-
  inspection_raw %>% 
  filter(grade %in% c("A","B","C")) %>%
  group_by(cuisine_description) %>% 
  summarise(n_obs=n()) %>% 
  filter(min_rank(desc(n_obs))<=10) 

grade_cuisine<-
  inspection_raw %>% 
  filter(grade %in% c("A","B","C") & cuisine_description %in% top_10_cuisine$cuisine_description) %>% 
  mutate(cuisine_description=fct_infreq(cuisine_description)) %>% 
  ggplot(aes(x=cuisine_description,fill=grade))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(
    x="Cuisine",
    y="Number"
  )

grade_boro/grade_cuisine
```

```{r}
## Yelp Rating vs. price boxplot 
inspection_raw %>% 
  filter(!is.na(price)) %>%
  ggplot(aes(x = price, y = rating, fill = price), data = .)+geom_boxplot()+labs(title = "Yelp Rating vs. Price")
```

```{r}
inspection_raw %>%
  filter(!is.na(grade),!is.na(boro)) %>%
  ggplot(aes(x = boro, y = grade, fill = grade), data =.) + geom_bar(stat = "identity", position="stack") + labs(title = "Inspection grade by Boroughs")
```

```{r}
inspection_raw %>%
  filter(!is.na(grade),!is.na(boro)) %>%
  filter(critical_flag == c("Critical", "Not Critical")) %>%
  ggplot(aes(x = boro, y = critical_flag, fill = critical_flag), data =.) + geom_bar(stat = "identity", position="stack") + labs(title = "Percent with critical flag by boroughs")
```

